{%- liquid
  assign menu_modal_id = section.id | append: '-menu-modal'
  assign menu_blocks = section.blocks | where: 'type', 'menu_item'

  assign show_desktop_menu = false
  if menu_blocks.size > 0
    assign show_desktop_menu = true
  endif

  assign show_mobile_toggle = true
-%}

<header class='grid items-center grid-cols-[auto_1fr_auto] gap-x-sm bg-p-lightest px-pagemargin 2xl:container'>
  {% comment %} -- Column 1: Logo -- {% endcomment %}
  <div class='flex items-center justify-start py-[11px]'>
    <a href='{{ routes.root_url }}' class='inline-flex'>
      {%- if settings.logo != blank -%}
        <div
          class='inline-flex w-auto h-[60px] md:h-[var(--header-logo-height,40px)] md:w-auto'
          style='--header-logo-height: {{ settings.logo_width | divided_by: settings.logo.aspect_ratio }}px; max-width: {{ settings.logo_width }}px;'
        >
          {%- assign logo_alt = settings.logo.alt | default: shop.name | escape -%}
          {%- assign logo_height = settings.logo_width | divided_by: settings.logo.aspect_ratio -%}
          {% capture sizes %}(max-width: {{ settings.logo_width | times: 2 }}px) 50vw, {{ settings.logo_width }}px{% endcapture %}
          {% capture widths %}{{ settings.logo_width }}, {{ settings.logo_width | times: 1.5 | round }}, {{ settings.logo_width | times: 2 | round }}{% endcapture %}
          {%- render 'image',
            image: settings.logo,
            height: logo_height,
            width: settings.logo_width,
            alt: logo_alt,
            sizes: sizes,
            widths: widths,
            preload: true,
            class: 'w-full h-full object-contain'
          -%}
        </div>
      {%- else -%}
        <span class='h2'>{{ shop.name }}</span>
      {%- endif -%}
    </a>
  </div>

  {% comment %} -- Column 2: Desktop Menu (Hidden on Mobile) -- {% endcomment %}
  {%- if show_desktop_menu -%}
    <div class='hidden lg:flex items-center justify-center h-full'>
      {% render 'header-mega-menu', blocks: section.blocks %}
    </div>
  {%- else -%}
    <div class='hidden lg:flex'></div>
    {%- comment %} Empty div to maintain grid structure {%- endcomment %}
  {%- endif -%}

  {% comment %} -- Column 3: Icons & Mobile Toggle -- {% endcomment %}
  <div class='flex items-center justify-end gap-[25px] md:gap-[30px]'>
    {%- render 'header-search', mobile: true -%}

    {%- if shop.customer_accounts_enabled -%}
      <a
        href='{%- if customer -%}{{ routes.account_url }}{%- else -%}{{ routes.account_login_url }}{%- endif -%}'
        class='hidden md:inline-flex'
      >
        {% render 'icon' with 'c-icon-account', size: 20 %}
        <span class='sr-only'>
          {%- liquid
            if customer
              echo 'customer.account_fallback' | t
            else
              echo 'customer.log_in' | t
            endif
          -%}
        </span>
      </a>
    {%- endif -%}

    {%- for block in section.blocks -%}
      {%- case block.type -%}
        {%- when '@app' -%}
          {% render block %}
      {%- endcase -%}
    {%- endfor -%}

    {%- capture cart_toggle_button -%}
      {%- render 'header-cart-icon' -%}
    {%- endcapture -%}

    {%- if template.name == 'cart' -%}
      {{- cart_toggle_button -}}
    {%- else -%}
      {% comment %}
        {%- render 'modal-dialog-toggle',
          modal_id: 'cart-drawer-dialog',
          label: 'Toggle Cart Modal',
          toggle_element: cart_toggle_button
        -%}
      {% endcomment %}
      {{- cart_toggle_button -}}
    {%- endif -%}

    {% comment %} Mobile Menu Toggle (Hamburger - Hidden on Desktop) {% endcomment %}
    {%- if show_mobile_toggle -%}
      {%- capture menu_toggle_button -%}
        <button
          aria-haspopup='dialog'
          aria-controls='{{ menu_modal_id }}'
          class="group/menutoggle inline-flex lg:hidden" {%- comment %} Hidden on large screens and up {% endcomment -%}
        >
          {%- render 'icon' with 'c-icon-menu', class: 'text-[22px] md:text-[32px]' -%}
          <span class="sr-only">{{ 'sections.header.menu' | t }}</span>
        </button>
      {%- endcapture -%}

      {%- render 'modal-dialog-toggle',
        modal_id: menu_modal_id,
        label: 'Toggle Menu Modal',
        toggle_element: menu_toggle_button
      -%}
    {%- endif -%}
  </div>
</header>

{%- comment %} Mobile Menu Modal (Drawer) - Render only if mobile menu is set {%- endcomment %}
{%- if show_mobile_toggle -%}
  {%- liquid
    capture menu_modal_content
      render 'header-drawer', section: section
    endcapture

    capture extra_controls
      render 'header-cart-icon'
    endcapture
    render 'modal-dialog', id: menu_modal_id, content: menu_modal_content, type: 'drawer', close_on_backdrop_click: true, show_logo: true, extra_controls: extra_controls
  -%}
{%- endif -%}

{%- comment %} Schema below uses placeholder text for translations as requested {%- endcomment %}
{% schema %}
{
  "name": "Header",
  "limit": 1,
  "class": "bg-p-lightest",
  "enabled_on": {
    "groups": ["header"]
  },
  "presets": [
    {
      "name": "Header"
    }
  ],
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_country_selector",
      "default": true,
      "label": "Enable country/region selector (in drawer)"
    },
    {
      "type": "checkbox",
      "id": "enable_language_selector",
      "default": true,
      "label": "Enable language selector (in drawer)"
    }
  ],
  "blocks": [
    {
      "type": "menu_item",
      "name": "Menu Item",
      "limit": 8,
      "settings": [
        {
          "type": "text",
          "id": "top_label",
          "label": "Top Level Label",
          "default": "Menu Item"
        },
        {
          "type": "url",
          "id": "top_link",
          "label": "Top Level Link (optional)"
        },
        {
          "type": "header",
          "content": "Mega Menu Columns (Max 3)"
        },
        {
          "type": "link_list",
          "id": "menu_1",
          "label": "Column 1 Menu"
        },
        {
          "type": "link_list",
          "id": "menu_2",
          "label": "Column 2 Menu"
        },
        {
          "type": "link_list",
          "id": "menu_3",
          "label": "Column 3 Menu"
        },
        {
          "type": "header",
          "content": "Mega Menu Promotion"
        },
        {
          "type": "image_picker",
          "id": "promo_image",
          "label": "Promo Image"
        },
        {
          "type": "text",
          "id": "promo_heading",
          "label": "Promo Heading",
          "default": "Promotion"
        },
        {
          "type": "richtext",
          "id": "promo_text",
          "label": "Promo Text"
        },
        {
          "type": "text",
          "id": "promo_link_label",
          "label": "Promo Link Label"
        },
        {
          "type": "url",
          "id": "promo_link_url",
          "label": "Promo Link URL"
        }
      ]
    },
    {
      "type": "separator",
      "name": "Separator",
      "limit": 1
    }
  ]
}
{% endschema %}
